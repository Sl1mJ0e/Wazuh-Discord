# Wazuh to Discord Integration

This is a custom integration for Wazuh that sends alerts to Discord using webhooks. It is an adaptation of the [original integration](https://eugenio-chaves.github.io/blog/2022/creating-a-custom-wazuh-integration/) with some modifications and improvements.

## Changes Made

1. The `generate_msg()` function has been updated to extract additional data fields from the Wazuh alert JSON, such as `srcport`, `srcuser`, `dstuser`, and `srcip`. It attempts to retrieve these values from different locations within the JSON structure to handle variations in the alert format.

2. The payload sent to Discord has been enhanced to include more information about the alert. It now includes the following fields:
   - Title: Wazuh Alert - Rule ID
   - Color: Determined based on the rule level (green for level 3, red for levels 6-12, yellow for others)
   - Description: The description of the rule
   - Fields:
     - Agent: The name of the agent that triggered the alert
     - Log Source: The location of the log that triggered the alert
     - Rule Level: The severity level of the rule
     - Data: Additional data extracted from the alert (SrcUser, SrcIP, SrcPort, DstUser)

3. Support for multiple agents has been added in a different way since the first version of the integration. The agent-webhook mappings are now stored in a separate `webhooks.json` file located in the `agent_webhooks` directory. This allows for easier management and updating of the mappings without modifying the script itself.


## How the Integration Works

1. When an alert is generated by Wazuh that matches the specified criteria (e.g., rule level, rule group), it triggers the custom integration.

2. The integration is defined in the Wazuh manager's configuration file (`ossec.conf`) using an `<integration>` block.

3. The `<integration>` block specifies the name of the custom integration (`custom-discord`) and the alert format (`json`).

4. When the integration is triggered, Wazuh executes a custom script (`custom-discord`) located in the `/var/ossec/integrations/` directory.

5. The `custom-discord` (`in the '/var/ossec/integrations directory`) script is a bash script that calls a Python script (`custom-discord.py`) with the appropriate arguments, including the path to the alert file.

6. The `custom-discord.py` script reads the alert file, extracts relevant information and generates a formatted message payload.

7. The `generate_msg()` function in `custom-discord.py` is responsible for creating the message payload that will be sent to the Discord webhook.

8. The script sends the formatted message payload to the specified Discord webhook URL using an HTTP POST request.

9. The Discord webhook receives the message payload and posts it in the designated channel.


## Implementing the Integration in Wazuh

1. Create a new webhook in your Discord server by going to the server settings, selecting the desired channel, and configuring the webhook.

2. Create a new directory named `agent_webhooks` in the same location as the `custom-discord.py` script.

3. Inside the `agent_webhooks` directory, create a file named `webhooks.json` with the following structure:
   ```json
   {
     "wazuh-agent-1": "https://discord.com/api/webhooks/your-webhook-url-1",
     "wazuh-agent-2": "https://discord.com/api/webhooks/your-webhook-url-2"
   }
   ```

4. Update the agent_webhooks dictionary with the appropriate agent names and their corresponding Discord webhook URLs.

5. Copy the contents of the custom-discord.py provided in this repo into the file (or just clone the repo).

6. Open the Wazuh manager's configuration file (`ossec.conf`) using a text editor:
- vim /var/ossec/etc/ossec.conf

7. Add the following `<integration>` block to the configuration file:
```xml
<integration>
  <name>custom-discord</name>
  <alert_format>json</alert_format>
</integration>
```

8. Make sure both the custom-discord and custom-discord.py scripts have execute permissions:
```
chmod +x /var/ossec/integrations/custom-discord
chmod +x /var/ossec/integrations/custom-discord.py
```

9. Restart the Wazuh manager to apply the changes:
```
systemctl restart wazuh-manager
```

## Credits

This integration is based on the work done by Eugenio Chaves in the [original blog post](https://eugenio-chaves.github.io/blog/2022/creating-a-custom-wazuh-integration/).